from contextlib import AsyncExitStack

from google.adk.tools.mcp_tool import MCPTool, MCPToolset
from google.adk.tools.mcp_tool.mcp_session_manager import SseServerParams

from utils.metasploit import create_metasploit_client


async def create_metasploit_tools() -> tuple[list[MCPTool], AsyncExitStack]:
    return await MCPToolset.from_server(
        connection_params=SseServerParams(
            url="http://localhost:8085/sse",
        ),
    )


def run_metasploit_wordpress_scanner(target_host: str, target_port: int, targeturi: str = "/"):
    """
    Metasploitのwordpress_scannerモジュールを実行する関数。

    Parameters:
    - target_host (str): スキャン対象のホスト (例: '127.0.0.1')
    - target_port (int): 対象ホストのポート番号 (例: 80)
    - targeturi (str): WordPressのベースパス (デフォルト: '/')

    Returns:
    - dict: スキャン結果の辞書
    """

    client = create_metasploit_client()
    scanner = client.modules.use("auxiliary", "scanner/http/wordpress_scanner")

    scanner["RHOSTS"] = target_host
    scanner["RPORT"] = target_port
    scanner["TARGETURI"] = targeturi

    job_id = scanner.execute()

    # ジョブの完了を待機
    while client.jobs.list:
        pass
    return {"status": "completed", "job_id": job_id}
