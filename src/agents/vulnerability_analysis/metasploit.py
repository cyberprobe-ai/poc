import re
import subprocess
from contextlib import AsyncExitStack

from google.adk.tools.mcp_tool import MCPTool, MCPToolset
from google.adk.tools.mcp_tool.mcp_session_manager import SseServerParams


async def create_metasploit_tools() -> tuple[list[MCPTool], AsyncExitStack]:
    return await MCPToolset.from_server(
        connection_params=SseServerParams(
            url="http://localhost:8085/sse",
        ),
    )


def msf_scan_wordpress_plugins(
    target_host: str,
    target_port: int,
    targeturi: str = "/",
) -> list[str]:
    """WordPressのプラグインリストを取得する。

    Parameters:
        target_host (str): スキャン対象のホスト (例: '127.0.0.1')
        target_port (int): 対象ホストのポート番号 (例: 80)
        targeturi (str): WordPressのベースパス (デフォルト: '/')

    Returns:
        list[str]: プラグインのリスト
            例: ['woocommerce-payments']
    """

    cmd = ["msfconsole", "-q", "-x", f"use auxiliary/scanner/http/wordpress_scanner; set RHOSTS {target_host}; set RPORT {target_port}; set TARGETURI {targeturi}; run; exit"]
    res = subprocess.run(cmd, capture_output=True, text=True, check=True)
    plugins = re.findall(r"Detected plugin: (.+) version .+", res.stdout)
    return list(set(plugins))
