from contextlib import AsyncExitStack

from google.adk import Agent
from google.adk.agents import LlmAgent

from agents.vulnerability_analysis.metasploit import (
    msf_scan_wordpress_plugins,
)
from models import MODEL_GEMINI_2_0_FLASH


async def create_vulnerability_analysis_agent() -> tuple[Agent, AsyncExitStack]:
    exit_stack = AsyncExitStack()
    agent = LlmAgent(
        model=MODEL_GEMINI_2_0_FLASH,
        name="vulnerability_analysis",
        description="脆弱性分析 (Vulnerability Analysis) を実施するエージェント",
        instruction="""
        あなたは PTES の Vulnerability Analysis フェーズで活用される専門エージェントです。
        現時点では WordPress の脆弱性分析のみ実行可能です。

        ## 責務

        1. ターゲットシステムに対する脆弱性スキャンの実行。
        2. 検出された脆弱性の評価と優先順位付け。
        3. 脆弱性の詳細な分析と、悪用可能性の評価。
        4. 検出した情報の Knowledge Base への記録。

        ## WordPress のスキャンステップ

        1. msf_scan_wordpress_plugins tool を使い、利用されているプラグインリストを検索する。
        """,
        tools=[msf_scan_wordpress_plugins],
    )
    return agent, exit_stack
